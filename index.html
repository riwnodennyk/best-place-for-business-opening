<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimate Foot Traffic for Your Business | Free Map Tool</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css" /> <!-- External CSS -->
</head>

<body>
    <div id="map"></div>
    <div id="loading">Calculating Foot Traffic in the Area...</div> <!-- Loading indicator -->

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script type="module">
        import { calculateArea } from './calculateArea.js';
        import { processBuildingData } from './businessDensity.js';

        var mapConfig = {
            // center: [50.177, 30.318], // vasylkiv
            // center: [50.079, 29.909], // Fastiv
            // center: [50.398, 30.619], // osokorky
            // center: [50.398, 30.630], // pozniaky
            // center: [50.403, 30.650], // kharkivska
            center: [50.398, 30.603], // slavutych
            // center: [50.450, 30.510], // zoloti vorota
            // center: [50.440, 30.520], // besarabka
            // center: [52.383, 4.632], // haarlem
            // center: [51.508, -0.128], // london
            zoom: 16,
            maxZoom: 18,
            minZoom: 14,
        };

        const map = L.map('map', {
            center: mapConfig.center,
            zoom: mapConfig.zoom,
            minZoom: mapConfig.minZoom,
            maxZoom: mapConfig.maxZoom
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        console.log("Map loaded");

        let buildingsLayer = L.geoJSON(null).addTo(map);
        let lastBounds = null;
        let currentRequestController = null;
        let loadingIndicator = document.getElementById('loading');

        function debounce(func, delay) {
            let timer;
            return function (...args) {
                clearTimeout(timer);
                timer = setTimeout(() => func.apply(this, args), delay);
            };
        }

        async function fetchData(bounds) {
            if (currentRequestController) {
                currentRequestController.abort(); // Cancel previous request
            }

            currentRequestController = new AbortController();
            const { signal } = currentRequestController;

            let bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            console.log("Fetching data for bbox:", bbox);

            const buildingsQuery = `
                [out:json][timeout:25];
                way["building"](${bbox});
                out body geom;
            `;

            const businessesQuery = `
                [out:json][timeout:25];
                (
                    node["shop"](${bbox});
                    node["office"](${bbox});
                    node["tourism"~"museum|attraction|gallery"](${bbox});
                    node["leisure"~"park|garden"](${bbox});
                    node[railway~"station|subway_entrance|tram_stop"](${bbox});
                    node[amenity~"restaurant|cafe|fast_food|pub|bar|marketplace|school|university|cinema|theatre|pharmacy|supermarket|mall|bank|bureau_de_change"](${bbox});                );
                out body;
            `;

            const buildingsUrl = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(buildingsQuery)}`;
            const businessesUrl = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(businessesQuery)}`;

            try {
                loadingIndicator.style.display = 'block'; // Keep loading indicator visible

                const [buildingsResponse, businessesResponse] = await Promise.all([
                    fetch(buildingsUrl, { signal }).then(res => res.json()),
                    fetch(businessesUrl, { signal }).then(res => res.json())
                ]);

                buildingsLayer.clearLayers(); // Remove old data
                let foundBuildings = false;

                buildingsResponse.elements.forEach(building => {
                    if (building.type === "way" && building.geometry) {
                        const isBuildingProcessed = processBuildingData(building, businessesResponse, calculateArea, buildingsLayer);
                        if (isBuildingProcessed) foundBuildings = true;
                    }
                });

                if (!foundBuildings) {
                    console.warn("No buildings with sufficient business density found.");
                }
                loadingIndicator.style.display = 'none'; // Hide loading indicator once fetching completes
            } catch (error) {
                if (error.name !== "AbortError") {
                    console.error("Error fetching data:", error);
                } else {
                    console.error("AbortError");
                }
            } finally {
            }
        }

        const debouncedFetchData = debounce(fetchData, 5*1000);

        function onMapMoveStart() {
            loadingIndicator.style.display = 'block'; // Show loading as soon as map starts moving
        }

        function onMapMoveEnd() {
            const bounds = map.getBounds();
            const currentBoundsString = bounds.toBBoxString();

            if (lastBounds !== currentBoundsString) {
                lastBounds = currentBoundsString;
                debouncedFetchData(bounds);
            }
        }

        map.whenReady(() => {
            fetchData(map.getBounds());
        });

        map.on("movestart", onMapMoveStart); // Show "loading" when moving starts
        map.on("moveend", onMapMoveEnd);     // Fetch data when moving stops
    </script>
</body>

</html>